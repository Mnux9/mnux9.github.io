<!DOCTYPE html>
<html>

<head>
</head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="../../assets/css/p.css">

</head>

<body>


  <div class="nav-bar">
    <div class="article-div"></div>
    <a class="mnux-name" href="index.html">mnux</a>
    <div class="color-test">
      <div class="color-box"></div>
    </div>

  </div>

  <div class="center">



  






    <h1 id="5-channel-i2c-pwm-switch">5 channel I2C PWM switch</h1>
<p><img src="IMG_1627.jpg"
     alt="image"
     style="float: left; margin-right: 10px; width:100%; padding-bottom: 2%;" /><br></p>
<h3 id="overview">Overview</h3>
<p>This board connects over a the two wire I2C bus and provides a 5 PWM low side switches. This can be handy if you are running low on GPIO (eg. ESP8266) or just want a simple solution.</p>
<h3 id="usage">Usage</h3>
<ul>
<li><strong>Arduino</strong> - I made a super simple library for arduino: <a href="https://github.com/Mnux9/i2c-PWM-expander/tree/main/I2CPWM" style="color :blue;">Download</a></li>
</ul>
<pre><code class="lang-c++"><span class="hljs-comment">//include the I2C PWM library you can download from mnux.xyz</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;I2CPWM.h&gt;</span></span>

<span class="hljs-comment">//creates an expander called "myExpander"</span>
<span class="hljs-function">I2CPWM <span class="hljs-title">myExpander</span><span class="hljs-params">(<span class="hljs-number">8</span>)</span></span>; <span class="hljs-comment">// selects an expander connected on address 8</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span></span>{
  <span class="hljs-comment">// to set a PWM value:</span>
  <span class="hljs-comment">// myExpander.setPWM(channel, value);</span>
  myExpander.setPWM(<span class="hljs-number">1</span>,<span class="hljs-number">128</span>); <span class="hljs-comment">// sets channel 1 to 50% duty</span>
}

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">loop</span><span class="hljs-params">()</span></span>{

}
</code></pre>


<ul>
<li><strong>ESP Home</strong> (Home Assistant) - You can easily use it from ESP Home without any custom libraries:</li>
</ul>
<hr>
<h3 id="component-choice">Component choice</h3>
<ul>
<li><p><strong>MCU</strong> - I wanted to use a purpose made I2C PWM expander however i couldn&#39;t find a suitable one so in the end i decided to use a WCH general purpose MCU and write my own firmware for it. It is a really cheap mcu and comes in a simple to solder package so i choose it even tho i have never used it before.</p>
</li>
<li><p><strong>Mosfets</strong> - D4814 mosfets which are cheap on ali.</p>
</li>
<li><p>For the optocouplers i used a THT version because they have a smaller footprint than their SMD counterparts.</p>
</li>
</ul>
<h3 id="firmware">Firmware</h3>
<ul>
<li><p>I used the openwch core for arduino IDE and made a simple firmware. On start it check for the address jumpers and starts an i2c with the appropriate address. After that it just waits for i2c traffic which triggers a function that interprets the messages and sets PWM outputs. <a href="https://github.com/Mnux9/i2c-PWM-expander/tree/main/I2C-PWM-FIRMWARE">Firmware download</a></p>
</li>
<li><p>A big problem with my first time trying to program a WCH chip was that i had no idea there were multiple kinds of programmers. The one i bought was just a WCH-Link, however for the CH32v003 i need a WCH-Link<em>E</em>. Oh well I ordered the right one and just developed the code on an UNO in the mean time.</p>
</li>
</ul>
<h3 id="circuitboard-layout">Circuitboard layout</h3>
<p>As always i used kicad, however this being a circuit with a lot of repeating layout I got to utilize some of its more advanced features and plugins.</p>
<h3 id="mistakes">Mistakes</h3>
<ul>
<li><p>This was my first time I used this microcontroller I expected there to be a few mistakes and ofc, on channels 2 and 4 i used a non PWM pins.</p>
</li>
<li><p>For some reason I also swapped the SCL and SDA... lol</p>
</li>
<li><p>While testing what component values to use and probing around, i noticed there is no voltage on the output + terminals (which there should be because the switching is done through the negative). Turns out i reversed the silkscreen on the input.</p>
</li>
</ul>
<h3 id="usecase">Usecase</h3>
<ul>
<li><p>I setup a second revision of my universal IOT board (now the IOT friend :3) with ESPHome on a top of my rack with this expander.</p>
</li>
<li><p>Discovering that my Prusa 3D printer has support in home assistant i setup a little light for it which lights up after i start a print job.</p>
</li>
</ul>
<p><img src="IMG_19062.jpg"
     alt="image"
     style="float: left; margin-left: 3%; margin-right: 3%; width:45%" /></p>
<p><img src="IMG_1679.jpeg"
     alt="image"
     style="float: left; width:45%" /><br></p>
<h3 id="conclusion">Conclusion</h3>
<p>Even tho the end device isnt really that interesting i thought it was still worth it making a blog post about it because of all the little techniques used that i never used in any other project. And for me, somebody who always used pre-made libraries for i2c devices it was very fun to learn how it works and make my own library.</p>
<h3 id="offtopic-blog-update-">offtopic (blog update)</h3>
<p>I have made this blog post into a mark down file which just embeds in HTML instead of just writing it in HTML like i used to. Sadly it kindof reminds me of the style how chat bots write (or one of my teachers exams who uses AI to make them).
So i wanted to say that I dont use any generative AI.</p>









  </div>


  </div>

</body>

</html>